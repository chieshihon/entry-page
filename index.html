<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>受付</title>
</head>
<body>
  <h2>受付画面</h2>
  <div id="status">初期化中…</div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ====== ここだけ設定 ======
    const LIFF_ID = "あなたのLIFF_ID";
    // Workers の /api/liff-start に合わせる
    const API_ENDPOINT = "https://あなたのWorkersドメイン/api/liff-start";
    // ==========================

    function qs(name) {
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }

    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
    }

    async function main() {
      const biz = qs("biz");                 // 事業者ID（QRに入っている）
      const bizNameFromQr = qs("bizName");   // 事業者名（QRに入れてもOK / 省略可）

      if (!biz) {
        setStatus("URLに biz がありません。QRのURLを確認してください。");
        return;
      }

      setStatus("LIFFを初期化中…");
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        setStatus("ログインが必要です。ログインへ移動します…");
        // QR→LIFFの導線で未ログインがあり得るのでログインさせる
        liff.login({ redirectUri: location.href });
        return;
      }

      setStatus("ユーザー情報を取得中…");
      const profile = await liff.getProfile(); // userId を取得
      const userId = profile.userId || "";

      if (!userId) {
        setStatus("userIdを取得できませんでした。");
        return;
      }

      // idToken（サーバで検証＆改ざん対策に使える）
      const idToken = liff.getIDToken() || "";

      setStatus("受付情報を送信中…");
      const payload = {
        biz,
        bizName: bizNameFromQr, // 空でもOK（空ならサーバ側でIDから引く）
        userId,
        idToken,
        pageUrl: location.href
      };

      const res = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      if (!res.ok) {
        setStatus("送信に失敗しました: " + text);
        return;
      }

      setStatus("受付が完了しました。LINEに反映しました。画面を閉じます…");
      setTimeout(() => {
        // LINE内ブラウザなら閉じる
        try { liff.closeWindow(); } catch (e) {}
      }, 900);
    }

    main().catch(err => {
      setStatus("エラー: " + (err && err.message ? err.message : String(err)));
    });
  </script>
</body>
</html>
